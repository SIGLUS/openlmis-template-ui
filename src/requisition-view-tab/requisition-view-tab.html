<!-- SIGLUS-REFACTOR: starts here -->
<div class="view-tab" suppress-tr-openlmis-invalid>
    <header class="sub-heading">
        <h3>{{'requisitionViewTab.products' | message}}</h3>
        <button class="add"
                ng-if="vm.requisition.template.extension.enableProduct"
                ng-disabled="vm.requisition.emergency && vm.requisition.requisitionLineItems.length >= 10"
                ng-click="vm.siglusAddProducts()"
        >
            {{'requisitionViewTab.addProduct' | message}}
        </button>
    </header>
    <div class="openlmis-table-container" ng-if="vm.requisition.template.extension.enableConsultationNumber && !vm.requisition.emergency">
        <table class="openlmis-table">
            <tbody>
            <tr class="text-center">
                <td colspan="2">{{'requisitionViewTab.normalRequisition' | message}}</td>
            </tr>
            <tr>
                <td>{{'requisitionViewTab.externalConsultationPerformedNo' | message}}</td>
                <!-- #385: alert when cursor leaves the input -->
                <td ng-if="vm.userCanEdit">
                    <div class="input-control" popover openlmis-invalid="{{vm.consultationNumberMessage}}" input-control>
                        <input positive-integer ng-model="vm.requisition.extraData.consultationNumber"
                               ng-change="vm.validateConsultationNumber()"
                               ng-blur="vm.validateConsultationNumber()"
                        />
                    </div>
                </td>
                <!-- #385: ends here -->
                <td ng-if="!vm.userCanEdit">
                    {{vm.requisition.extraData.consultationNumber}}
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <kit-usage sections="vm.requisition.usageTemplate.kitUsage"
               line-items="vm.requisition.kitUsageLineItems"
               can-edit="vm.userCanEdit"
               ng-if="vm.requisition.template.extension.enableKitUsage && !vm.requisition.emergency"/>
    <div class="toolbar skipbar" ng-if="vm.requisition.template.extension.enableProduct && vm.showSkipControls">
        <h4>{{'requisitionViewTab.skip' | message}}</h4>
        <ul>
            <li><a ng-click="vm.requisition.skipAllLineItems()">{{'requisitionViewTab.all' | message}}</a></li>
            <li><a ng-click="vm.requisition.unskipAllLineItems()">{{'requisitionViewTab.none' | message}}</a></li>
        </ul>
    </div>
    <div class="openlmis-table-container requisition-product" ng-if="vm.requisition.template.extension.enableProduct">
<!-- SIGLUS-REFACTOR: ends here -->
        <table>
            <caption ng-if="!vm.items.length">{{vm.noProductsMessage | message}}</caption>
            <thead>
            <tr>
                <th class="col-{{column.name}}" ng-repeat="column in vm.columns | orderBy : 'displayOrder'"
                    ng-class="{'col-sticky': !column.$canChangeOrder}" popover="{{vm.getDescriptionForColumn(column)}}"
                    popover-trigger-area="element">{{column.label}}</th>
                <th class="col-sticky sticky-right" ng-if="vm.showDeleteColumn()"></th>
            </tr>
            </thead>
            <tbody ng-repeat="(category, lineItems) in vm.items | groupBy:'$program.orderableCategoryDisplayName'" tbody-title="{{category}}">
            <tr ng-repeat="lineItem in lineItems | orderBy : '$program.displayOrder'" ng-class="{'skipped-line-item' : lineItem.skipped}">
                <td ng-repeat="column in vm.columns | orderBy : 'displayOrder'"
                    product-grid-cell
                    requisition="vm.requisition"
                    column="column"
                    line-item="lineItem"
                    user-can-edit="vm.userCanEdit"
                    can-approve="vm.canApproveAndReject">
                </td>
                <td ng-if="vm.showDeleteColumn()">
                    <button class="hide-line-item"
                            ng-click="vm.deleteLineItem(lineItem)"
                            ng-if="lineItem.$deletable">
                        <i class="fa fa-remove"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <openlmis-pagination
                list="vm.lineItems"
                paged-list="vm.items"
                pagination-id="vm.paginationId"
                on-page-change="vm.cacheRequisition"/>
    </div>
    <usage-information sections="vm.requisition.usageTemplate.usageInformation"
               line-items="vm.requisition.usageInformationLineItems"
               processing-period-end-date="vm.requisition.processingPeriod.endDate"
               available-products="vm.requisition.availableFullSupplyProducts"
               added-products="vm.requisition.requisitionLineItems"
               can-edit="vm.userCanEdit"
               ng-if="vm.requisition.template.extension.enableUsageInformation && !vm.requisition.emergency"/>
    <siglus-patient sections="vm.requisition.usageTemplate.patient"
                    line-items="vm.requisition.patientLineItems"
                    can-edit="vm.userCanEdit"
                    ng-if="vm.requisition.template.extension.enablePatient && !vm.requisition.emergency"
    ></siglus-patient>
    <!-- #375: create requisition with test consumption section -->
    <siglus-test-consumption
            program="vm.program"
            sections="vm.requisition.usageTemplate.rapidTestConsumption"
            line-items="vm.requisition.testConsumptionLineItems"
            can-edit="vm.userCanEdit"
            ng-if="vm.requisition.template.extension.enableRapidTestConsumption && !vm.requisition.emergency"
    />
    <!-- #: ends here -->
</div>
